#!/usr/bin/env node
'use strict';

/**
 * PreCompact Hook: Save External Memory Before Context Compaction
 *
 * This hook captures the current conversation context and saves it to
 * plans/reports/ before memory compaction occurs, preventing loss of
 * important analysis, findings, and progress during long-running tasks.
 *
 * Triggered by: PreCompact event (manual or auto compaction)
 *
 * Exit Codes:
 *   0 - Success (non-blocking)
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const {
  loadConfig,
  resolveNamingPattern,
  getReportsPath,
  resolvePlanPath,
  normalizePath
} = require('./lib/ck-config-utils.cjs');
const { ensureDir } = require('./lib/ck-paths.cjs');
const { exportTodosForCheckpoint } = require('./lib/todo-state.cjs');

/**
 * Get current git branch safely
 */
function getGitBranch() {
  try {
    return execSync('git branch --show-current', {
      encoding: 'utf8',
      stdio: ['pipe', 'pipe', 'pipe']
    }).trim();
  } catch (e) {
    return null;
  }
}

/**
 * Format timestamp for filename
 */
function formatTimestamp() {
  const now = new Date();
  const pad = (n) => String(n).padStart(2, '0');
  return `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
}

/**
 * Extract key information from context window data
 */
function extractContextSummary(contextWindow) {
  if (!contextWindow) return null;

  return {
    totalInputTokens: contextWindow.total_input_tokens || 0,
    totalOutputTokens: contextWindow.total_output_tokens || 0,
    contextWindowSize: contextWindow.context_window_size || 0,
    utilizationPercent: contextWindow.context_window_size
      ? Math.round(((contextWindow.total_input_tokens + contextWindow.total_output_tokens) / contextWindow.context_window_size) * 100)
      : 0
  };
}

/**
 * Build external memory content
 */
function buildMemoryContent(payload, config, sessionId) {
  const timestamp = new Date().toISOString();
  const gitBranch = getGitBranch();
  const contextSummary = extractContextSummary(payload.context_window);

  const lines = [
    '# Context Memory Checkpoint',
    '',
    '> Auto-saved before context compaction to preserve analysis and progress.',
    '',
    '## Session Info',
    '',
    `- **Timestamp:** ${timestamp}`,
    `- **Session ID:** ${sessionId || 'unknown'}`,
    `- **Trigger:** ${payload.trigger || 'unknown'}`,
    `- **Branch:** ${gitBranch || 'unknown'}`,
    `- **Working Directory:** ${process.cwd()}`,
    ''
  ];

  if (contextSummary) {
    lines.push(
      '## Context Window Stats',
      '',
      `- **Input Tokens:** ${contextSummary.totalInputTokens.toLocaleString()}`,
      `- **Output Tokens:** ${contextSummary.totalOutputTokens.toLocaleString()}`,
      `- **Window Size:** ${contextSummary.contextWindowSize.toLocaleString()}`,
      `- **Utilization:** ${contextSummary.utilizationPercent}%`,
      ''
    );
  }

  // Include todo state for preservation
  const todoExport = exportTodosForCheckpoint();
  if (todoExport && todoExport.todos.length > 0) {
    lines.push(
      '## Todo List State',
      '',
      `- **Total Tasks:** ${todoExport.taskCount}`,
      `- **Pending:** ${todoExport.pendingCount}`,
      `- **In Progress:** ${todoExport.inProgressCount || 0}`,
      `- **Completed:** ${todoExport.completedCount || 0}`,
      `- **Last Updated:** ${todoExport.timestamp}`,
      ''
    );

    lines.push('### Active Todos', '');
    todoExport.todos.forEach((todo, i) => {
      const status = todo.status === 'completed' ? '[x]' :
                     todo.status === 'in_progress' ? '[~]' : '[ ]';
      lines.push(`${i + 1}. ${status} ${todo.content}`);
    });
    lines.push('');
  }

  lines.push(
    '## Recovery Instructions',
    '',
    'Session resume will auto-restore todos from this checkpoint.',
    '',
    'Manual recovery (if needed):',
    '1. Read this checkpoint file to restore context',
    '2. Recreate todos from "Active Todos" section above using TodoWrite',
    '3. Check `plans/reports/` for related analysis files',
    '4. Continue from the last documented progress point',
    '',
    '## Active Context',
    '',
    '<!-- LLM: Add your current analysis, findings, and progress below -->',
    '',
    '### Current Task',
    '',
    '(No task context captured - this is auto-generated)',
    '',
    '### Key Findings',
    '',
    '(To be filled by manual checkpoints)',
    '',
    '### Progress Summary',
    '',
    '(To be filled by manual checkpoints)',
    '',
    '### Next Steps',
    '',
    '(To be filled by manual checkpoints)',
    '',
    '---',
    '',
    '*This file was auto-generated by the PreCompact hook.*',
    '*For better context preservation, use `/checkpoint` during long tasks.*',
    ''
  );

  return lines.join('\n');
}

/**
 * Main execution
 */
async function main() {
  try {
    const stdin = fs.readFileSync(0, 'utf-8').trim();
    if (!stdin) {
      process.exit(0);
    }

    const payload = JSON.parse(stdin);
    const sessionId = payload.session_id || process.env.CK_SESSION_ID || 'default';
    const config = loadConfig({ includeProject: false, includeAssertions: false });

    // Determine output path
    const gitBranch = getGitBranch();
    const resolved = resolvePlanPath(sessionId, config);
    const reportsPath = getReportsPath(resolved.path, resolved.resolvedBy, config.plan, config.paths);

    // Ensure reports directory exists
    const fullReportsPath = path.resolve(process.cwd(), reportsPath);
    ensureDir(fullReportsPath);

    // Generate filename
    const timestamp = formatTimestamp();
    const filename = `memory-checkpoint-${timestamp}.md`;
    const filePath = path.join(fullReportsPath, filename);

    // Build and write memory content
    const content = buildMemoryContent(payload, config, sessionId);
    fs.writeFileSync(filePath, content, 'utf8');

    // Output message for LLM context
    const todoExport = exportTodosForCheckpoint();
    console.log(`## External Memory Saved`);
    console.log('');
    console.log(`Context checkpoint saved to: \`${path.relative(process.cwd(), filePath)}\``);
    if (todoExport && todoExport.todos.length > 0) {
      console.log(`Todo state preserved: ${todoExport.pendingCount} pending, ${todoExport.inProgressCount || 0} in-progress tasks`);
    }
    console.log('');
    console.log('**On resume:** Todos will be auto-restored from checkpoint.');

    process.exit(0);
  } catch (error) {
    // Silent fail - don't block compaction
    if (process.env.CK_DEBUG) {
      console.error(`[save-context-memory] Error: ${error.message}`);
    }
    process.exit(0);
  }
}

main();
