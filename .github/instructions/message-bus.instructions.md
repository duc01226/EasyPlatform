---
applyTo: 'src/PlatformExampleApp/**/*Consumer*.cs,src/PlatformExampleApp/**/*Producer*.cs,src/PlatformExampleApp/**/*MessageBus*.cs'
excludeAgent: ['copilot-code-review']
description: 'Message bus patterns for cross-service communication in EasyPlatform'
---

# Message Bus Patterns

## Entity Event Bus Producer

```csharp
// Automatically publishes entity changes to message bus
public class EmployeeEntityEventBusMessageProducer :
    PlatformCqrsEntityEventBusMessageProducer<EmployeeEntityEventBusMessage, Employee, string>
{
}
```

## Entity Event Bus Consumer

```csharp
internal sealed class UpsertOrDeleteEmployeeConsumer
    : PlatformApplicationMessageBusConsumer<EmployeeEntityEventBusMessage>
{
    private readonly IServiceRepository<EmployeeInfo> repository;
    private readonly ICompanyRepository companyRepository;

    public override async Task<bool> HandleWhen(EmployeeEntityEventBusMessage msg, string routingKey)
        => true;  // Filter logic if needed

    public override async Task HandleLogicAsync(EmployeeEntityEventBusMessage msg, string routingKey)
    {
        // CREATE/UPDATE
        if (msg.Payload.CrudAction == Created ||
            (msg.Payload.CrudAction == Updated && !msg.Payload.EntityData.IsDeleted))
        {
            // Wait for dependencies with timeout
            var (companyMissing, userMissing) = await (
                Util.TaskRunner.TryWaitUntilAsync(
                    () => companyRepository.AnyAsync(c => c.Id == msg.Payload.EntityData.CompanyId),
                    maxWaitSeconds: msg.IsForceSync ? 30 : 300).Then(p => !p),
                Util.TaskRunner.TryWaitUntilAsync(
                    () => userRepository.AnyAsync(u => u.Id == msg.Payload.EntityData.UserId),
                    maxWaitSeconds: 300).Then(p => !p)
            );

            if (companyMissing || userMissing) return;  // Skip if dependencies missing

            var existing = await repository.FirstOrDefaultAsync(
                e => e.Id == msg.Payload.EntityData.Id);

            if (existing == null)
            {
                await repository.CreateAsync(
                    msg.Payload.EntityData.ToLocalEntity()
                        .With(e => e.LastMessageSyncDate = msg.CreatedUtcDate));
            }
            else if (existing.LastMessageSyncDate <= msg.CreatedUtcDate)
            {
                await repository.UpdateAsync(
                    msg.Payload.EntityData.UpdateLocalEntity(existing)
                        .With(e => e.LastMessageSyncDate = msg.CreatedUtcDate));
            }
        }

        // DELETE
        if (msg.Payload.CrudAction == Deleted ||
            (msg.Payload.CrudAction == Updated && msg.Payload.EntityData.IsDeleted))
        {
            await repository.DeleteAsync(msg.Payload.EntityData.Id);
        }
    }
}
```

## Key Patterns

| Pattern               | Purpose                            |
| --------------------- | ---------------------------------- |
| `TryWaitUntilAsync`   | Wait for dependencies with timeout |
| `LastMessageSyncDate` | Prevent race condition overwrites  |
| `IsForceSync`         | Handle sync requests differently   |
| `HandleWhen`          | Filter which messages to process   |

## Message Types

```csharp
// Entity sync message (auto-generated by producer)
public class EmployeeEntityEventBusMessage :
    PlatformCqrsEntityEventBusMessage<Employee, string>
{
}

// Custom message for specific actions
public class EmployeeStatusChangedMessage : PlatformBusMessage
{
    public string EmployeeId { get; set; }
    public EmployeeStatus OldStatus { get; set; }
    public EmployeeStatus NewStatus { get; set; }
}
```

## Message Naming Convention

| Type    | Producer Role | Pattern                                           | Example                                            |
| ------- | ------------- | ------------------------------------------------- | -------------------------------------------------- |
| Event   | Leader        | `<ServiceName><Feature><Action>EventBusMessage`   | `CandidateJobBoardApiSyncCompletedEventBusMessage` |
| Request | Follower      | `<ConsumerServiceName><Feature>RequestBusMessage` | `JobCreateNonexistentJobsRequestBusMessage`        |

**Event Messages (Producer is Leader):**

- Producer defines the message schema
- Named with producer's service name prefix
- Example: Candidate service publishes `CandidateJobBoardApiSyncCompletedEventBusMessage`
- Consumer class matches: `CandidateJobBoardApiSyncCompletedEventBusMessageConsumer`

**Request Messages (Consumer is Leader):**

- Consumer defines the message schema
- Named with consumer's service name prefix
- Example: Job service needs data, defines `JobCreateNonexistentJobsRequestBusMessage`

**Consumer Naming:**

- Consumer class name = Message class name + `Consumer` suffix
- Location: `{ConsumerService}.Application/MessageBus/Consumers/`

## Anti-Patterns

- **Never** access other service's database directly
- **Never** skip dependency wait for critical data
- **Never** forget LastMessageSyncDate for race conditions
- **Never** assume message order (use timestamps)
